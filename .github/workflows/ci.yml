name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: osrf/ros:jazzy-desktop-full

    steps:
    - uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        apt-get update && apt-get install -y \
          build-essential \
          cmake \
          git \
          wget \
          libarmadillo-dev \
          libpcl-dev \
          libeigen3-dev \
          python3-colcon-common-extensions \
          python3-colcon-mixin \
          python3-rosdep

    - name: Install NLopt
      run: |
        git clone -b v2.7.1 https://github.com/stevengj/nlopt.git
        cd nlopt
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        make install
        ldconfig
        cd ../..
        rm -rf nlopt

    - name: Install ROS Dependencies
      run: |
        rosdep init || true
        rosdep update
        rosdep install --from-paths src --ignore-src -r -y

    - name: Step 1: Utilities
      shell: bash
      run: |
        source /opt/ros/jazzy/setup.bash
        colcon build --packages-select cmake_utils pose_utils quadrotor_msgs uav_utils poscmd_2_odom waypoint_generator odom_visualization map_generator so3_disturbance_generator swarmtal_msgs --symlink-install --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo

    - name: Step 2: Core Planning
      shell: bash
      run: |
        source /opt/ros/jazzy/setup.bash
        colcon build --packages-select bspline poly_traj path_searching bspline_opt plan_env traj_utils active_perception --symlink-install --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo

    - name: Step 3: Planning Management
      shell: bash
      run: |
        source /opt/ros/jazzy/setup.bash
        colcon build --packages-select plan_manage exploration_manager --symlink-install --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo

    - name: Step 4: Simulator & Rendering
      shell: bash
      run: |
        source /opt/ros/jazzy/setup.bash
        colcon build --packages-select so3_control so3_quadrotor_simulator local_sensing multi_map_server --symlink-install --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo

    - name: Step 5: Full Workspace
      shell: bash
      run: |
        source /opt/ros/jazzy/setup.bash
        colcon build --packages-up-to plan_bringup --symlink-install --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo
